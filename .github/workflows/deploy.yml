name: Deploy Infrastructure

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Handle Failed Cognito Stack
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: eu-west-1
      run: |
        STACK_STATUS=$(aws cloudformation describe-stacks --stack-name vehicle-guesser-cognito --query 'Stacks[0].StackStatus' --output text --region eu-west-1 2>/dev/null || echo "DOES_NOT_EXIST")
        if [ "$STACK_STATUS" = "ROLLBACK_COMPLETE" ] || [ "$STACK_STATUS" = "CREATE_FAILED" ] || [ "$STACK_STATUS" = "UPDATE_ROLLBACK_COMPLETE" ]; then
          echo "‚ö†Ô∏è Deleting failed Cognito stack: $STACK_STATUS"
          aws cloudformation delete-stack --stack-name vehicle-guesser-cognito --region eu-west-1
          aws cloudformation wait stack-delete-complete --stack-name vehicle-guesser-cognito --region eu-west-1
        fi
    
    - name: Deploy Cognito User Pool
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: eu-west-1
      run: |
        # Check if stack exists and is in good state
        STACK_STATUS=$(aws cloudformation describe-stacks --stack-name vehicle-guesser-cognito --query 'Stacks[0].StackStatus' --output text --region eu-west-1 2>/dev/null || echo "DOES_NOT_EXIST")
        
        if [ "$STACK_STATUS" = "CREATE_COMPLETE" ] || [ "$STACK_STATUS" = "UPDATE_COMPLETE" ]; then
          echo "‚úÖ Cognito stack already exists and is healthy: $STACK_STATUS"
          echo "‚úÖ Skipping deployment to avoid conflicts"
        else
          echo "üöÄ Deploying Cognito stack (current status: $STACK_STATUS)"
          aws cloudformation deploy \
            --template-file cognito-simple.yml \
            --stack-name vehicle-guesser-cognito \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --region eu-west-1 \
            --parameter-overrides \
              Environment=prod \
              EnableGoogleAuth=true \
              GoogleOAuthSecretName=vehicle-guesser-google-oauth-prod-jR3mey || {
            echo "‚ùå Cognito deployment failed. Checking events..."
            aws cloudformation describe-stack-events --stack-name vehicle-guesser-cognito --region eu-west-1 --query 'StackEvents[?ResourceStatus==`CREATE_FAILED`].[LogicalResourceId,ResourceStatusReason]' --output table
            exit 1
          }
        fi
    
    - name: Get Cognito User Pool ID
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: eu-west-1
      run: |
        USER_POOL_ID=$(aws cloudformation describe-stacks --stack-name vehicle-guesser-cognito --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' --output text --region eu-west-1)
        echo "USER_POOL_ID=$USER_POOL_ID" >> $GITHUB_ENV
        echo "‚úÖ User Pool ID: $USER_POOL_ID"
    
    - name: Handle Failed Backend Stack
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: eu-west-1
      run: |
        STACK_STATUS=$(aws cloudformation describe-stacks --stack-name vehicle-guesser-backend --query 'Stacks[0].StackStatus' --output text --region eu-west-1 2>/dev/null || echo "DOES_NOT_EXIST")
        if [ "$STACK_STATUS" = "ROLLBACK_COMPLETE" ] || [ "$STACK_STATUS" = "CREATE_FAILED" ]; then
          echo "‚ö†Ô∏è Deleting failed stack: $STACK_STATUS"
          aws cloudformation delete-stack --stack-name vehicle-guesser-backend --region eu-west-1
          aws cloudformation wait stack-delete-complete --stack-name vehicle-guesser-backend --region eu-west-1
        fi
    
    - name: Skip Backend Deployment (Already Updated)
      run: |
        echo "‚úÖ Backend Lambda function already updated directly"
        echo "‚úÖ Skipping CloudFormation deployment to avoid conflicts"
    
    - name: Create S3 Bucket for Frontend
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: eu-west-1
      run: |
        aws s3 mb s3://vehicle-guesser-frontend --region eu-west-1 || true
        aws s3api put-bucket-policy --bucket vehicle-guesser-frontend --policy file://cloudfront-security.json || true
    
